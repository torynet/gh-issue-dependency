---
name: Implement comprehensive validation engine with circular dependency detection
status: open
created: 2025-09-06T21:39:41Z
updated: 2025-09-06T21:45:33Z
github: https://github.com/torynet/gh-issue-dependency/issues/17
depends_on: [16]
parallel: false
conflicts_with: []
---

# Task: Implement comprehensive validation engine with circular dependency detection

## Description
Create a robust validation engine that performs multi-layer validation including issue existence, permission checking, circular dependency detection using graph traversal, self-reference prevention, and duplicate relationship detection. This is the core safety mechanism for the add command.

## Acceptance Criteria
- [ ] Issue existence validation for both source and target issues
- [ ] Permission validation for write access to repositories
- [ ] Circular dependency detection using depth-first search algorithm
- [ ] Self-reference prevention (issue cannot depend on itself)
- [ ] Duplicate relationship detection with clear messaging
- [ ] Multi-layer validation pipeline with early termination on failures
- [ ] Validation results include actionable error messages and recovery guidance
- [ ] Integration with repository context detection from cli-foundation

## Technical Details
- **Implementation approach**: Multi-layer validation pipeline with graph algorithms for circular dependency detection
- **Key considerations**: Graph traversal efficiency, permission checking, comprehensive error messaging
- **Code locations**: pkg/validation.go (or similar), integration with cmd/add.go

Validation pipeline to implement:
```go
type ValidationPipeline struct {
    client *github.Client
}

func (v *ValidationPipeline) ValidateRelationship(source, target IssueRef, relType string) error {
    // Layer 1: Input validation
    if err := v.validateInputs(source, target, relType); err != nil {
        return err
    }
    
    // Layer 2: Permission validation
    if err := v.validatePermissions(source, target); err != nil {
        return err
    }
    
    // Layer 3: Existence validation
    if err := v.validateExistence(source, target); err != nil {
        return err
    }
    
    // Layer 4: Business logic validation
    if err := v.validateBusinessLogic(source, target, relType); err != nil {
        return err
    }
    
    return nil
}
```

Circular dependency detection algorithm:
```go
func detectCircularDependency(source, target IssueRef, client *github.Client) error {
    visited := make(map[string]bool)
    path := []string{}
    return dfsCircularCheck(target, source, visited, path, client)
}

func dfsCircularCheck(current, goal IssueRef, visited map[string]bool, path []string, client *github.Client) error {
    key := fmt.Sprintf("%s/%s#%d", current.Owner, current.Repo, current.Number)
    
    if key == goal.String() {
        return fmt.Errorf("circular dependency detected: %s", strings.Join(path, " â†’ "))
    }
    
    if visited[key] {
        return nil
    }
    
    visited[key] = true
    path = append(path, key)
    
    // Get dependencies and recurse
    deps, err := getDependencies(current, client)
    if err != nil {
        return err
    }
    
    for _, dep := range deps {
        if err := dfsCircularCheck(dep, goal, visited, path, client); err != nil {
            return err
        }
    }
    
    return nil
}
```

## Dependencies
- [ ] Task 001 completed (command structure exists)
- [ ] GitHub API client patterns from dependency-list
- [ ] Repository context detection from cli-foundation
- [ ] Understanding of GitHub's dependency API structure

## Effort Estimate
- Size: L
- Hours: 3-4 hours
- Parallel: false (complex validation logic blocks API integration)

## Definition of Done
- [ ] All validation layers implemented and tested
- [ ] Circular dependency detection correctly prevents cycles
- [ ] Self-reference attempts are blocked with clear messages
- [ ] Permission validation works for cross-repository scenarios
- [ ] Duplicate relationship detection identifies existing relationships
- [ ] Error messages provide specific, actionable guidance
- [ ] Validation pipeline integrates with command structure
